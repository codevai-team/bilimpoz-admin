# Изменения в системе аутентификации

## Что было изменено

### 1. Убрана временная заглушка из `auth.ts`
- Удалена временная заглушка, которая всегда возвращала первого админа из БД
- Реализована полноценная JWT аутентификация
- Добавлены функции для генерации и проверки JWT токенов

### 2. Обновлен процесс аутентификации
- После успешной верификации кода в Telegram теперь генерируется JWT токен
- Токен сохраняется в cookies на клиентской стороне
- Все API запросы теперь используют Authorization header с Bearer токеном

### 3. Обновлен middleware
- Добавлена проверка JWT токенов для защищенных маршрутов (/dashboard)
- Автоматическое перенаправление на /login при отсутствии или недействительном токене
- Проверка роли пользователя (только админы могут попасть в dashboard)

### 4. Обновлены компоненты
- `TelegramVerificationForm` теперь сохраняет JWT токен после верификации
- `useUser` хук обновлен для работы с JWT токенами
- Все API запросы в dashboard компонентах обновлены для использования JWT

## Новые файлы

1. `src/lib/client-auth.ts` - утилиты для работы с аутентификацией на клиентской стороне
2. `src/app/api/user/me/route.ts` - API роут для получения текущего пользователя
3. `middleware.ts` - корневой middleware файл для Next.js

## Переменные окружения

Добавьте в ваш `.env` файл:
```
JWT_SECRET=your-super-secret-jwt-key-change-in-production
```

**ВАЖНО**: В продакшене обязательно измените JWT_SECRET на случайную строку!

## Как это работает

1. Пользователь вводит логин/пароль → отправляется код в Telegram
2. Пользователь вводит код → генерируется JWT токен и сохраняется в cookies
3. При каждом запросе к API токен проверяется через Authorization header
4. Middleware проверяет токен для защищенных страниц (/dashboard)
5. При истечении токена пользователь автоматически перенаправляется на /login

## Безопасность

- JWT токены имеют срок действия 24 часа
- Токены проверяются на каждом API запросе
- Статус пользователя проверяется при каждой аутентификации
- Заблокированные/удаленные пользователи не могут получить доступ
